import React from 'react'
import ReactResizeDetector from 'react-resize-detector'
import FunnelGraph from 'funnel-graph-js'
import isString from 'lodash/isString'
import Color from 'color'
import FunnelStyled from './styled'

const defaults = {
  gradientDirection: 'horizontal',
  subLabelValue: 'percent',
  direction: 'horizontal',
  displayPercent: true,
}

const getColors = base => {
  if (isString(base)) return [base, Color(base).darken(0.2).rotate(20)]
  return base
}

class Funnel extends React.Component {
  size = {}

  onRef = (ref) => {
    if (!this.ref) {
      const options = this.props.options || {}
      this.graph = new FunnelGraph({
        container: '.funnel',
        ...defaults,
        data: this.format(this.props.data),
        width: this.props.width || this.size.width,
        height: this.props.height || this.size.height,
        ...options,
      })
      this.graph.draw()
      this.ref = ref
    }
  }

  componentDidUpdate (prevProps) {
    if (prevProps.data !== this.props.data) this.updateData(this.props.data)
    if (prevProps.options !== this.props.options) this.graph.update(this.props.options)
  }

  onResize = (width, height) => {
    if (this.graph) {
      if (height !== this.size.height) this.graph.updateHeight(height - 102)
      if (width !== this.size.width) this.graph.updateWidth(width)
    }
    this.size = { width, height }
  }

  updateData (data) {
    this.graph.updateData(this.format(data))
    return this
  }

  format = ({ labels, datasets }) => {
    const values = datasets.map(({ data }) => data)
    const colors = datasets.map(({ color }) => getColors(color))
    const subLabels = datasets.map(({ label }) => label)
    return {
      labels,
      values,
      colors,
      subLabels,
    }
  }

  render () {
    let el = <FunnelStyled ref={this.onRef} className='funnel' />
    if (!this.props.width && !this.props.height) {
      el = (
        <ReactResizeDetector handleWidth handleHeight onResize={this.onResize}>
          {el}
        </ReactResizeDetector>
      )
    }
    return el
  }
}

export default Funnel
